{
  "timestamp": "2026-01-21T23:32:09+09:00",
  "git_head": "7474b4dc24305bb065ad5f73289d1dccd4d471af",
  "completed_tasks": [
    "Public Alpha ops: NEUROLEAGUE_PUBLIC_BASE_URL + proxy headers + /api/ready + /api/metrics",
    "Prod-like compose: docker-compose.prod.yml (Postgres + MinIO + Ray head/worker + nginx web)",
    "Growth loop: /clips feed (trending/new + cursor) + Remix (fork) + ranked CTA",
    "Trending v2: conversion-weighted ranking + completion (>=80%) event",
    "Share deep links: /s/* OG landings + /start guest auto-onboarding + ref propagation",
    "Referrals: first ranked completion credits cosmetics (device/IP soft anti-abuse)",
    "Trust/Safety: report + hide + admin-gated /api/ops/reports",
    "Ranked transparency: matchmaking_reason + analytics human_match_rate KPI",
    "Ops maintenance: make ops-clean render_jobs retention/orphan cleanup",
    "Metrics/experiments: canonical events + deterministic assignments + daily funnels + ops dashboard (/ops)",
    "Beat This challenges: /api/challenges + /s/challenge OG + /challenge accept flow",
    "Content packs: pack.json + replay pack_hash + ops preflight report",
    "Public alpha deploy: docker-compose.deploy.yml + .env.deploy.example + make deploy-up/down/logs",
    "Ops deploy sanity: /api/ops/status + /ops UI panel",
    "Discord OAuth: /api/auth/discord/* + guest upgrade/merge (mock-friendly)",
    "Social: follows + /api/feed/activity + /social UI",
    "LiveOps ops: /ops/weekly override + /ops/packs promotion plan + patch notes append",
    "Deploy confidence CI: deploy-smoke-compose workflow boots docker-compose.deploy.yml with .env.deploy.ci.example and runs deploy smoke + OG checks (uploads deploy-smoke-diagnostics on failure)",
    "Share kit: /s/* QR + copy caption/link + deterministic share captions + cached MP4 + build code + tracking events",
    "Creator Pack: /s/clip/{replay_id}/kit.zip (mp4/thumb/caption/qr) + share/replay Download Kit",
    "Shorts-ready best clip: capv4 caption templates (clutch<=5, portal/augment) + 6–12s segment clamp + cache key versioning",
    "Production hardening: X-Request-Id + HTTP latency histogram + ops recent errors + hot query indexes + dual(user+ip) rate limits + Retry-After consistency",
    "Launch ops: experiment variant KPIs + featured tomorrow preview + Discord daily post includes Beat/Remix/Build Code",
    "Ops funnel KPIs: share/clips daily funnels (share_v1/clips_v1) + /api/ops/metrics/funnel_daily + /ops UI cards",
    "UGC polish: /s/build exposes build code + blueprint lineage top forks list",
    "Scheduler autopilot: KST-day deterministic featured rotation (clip/build/user, ops override respected)",
    "E2E stability: disable uvicorn reload when NEUROLEAGUE_E2E_FAST=1",
    "Steam Demo Mode: NEUROLEAGUE_DEMO_MODE + /demo guided run (guest → preset → instant match → replay/best clip → kit.zip → Beat This)",
    "VPS rehearsal: scripts/vps_rehearsal_check.sh wrapper for deploy smoke validation (OG meta + Range 206 + kit.zip listing)",
    "Multi-instance safety: Postgres advisory locks for scheduler + SKIP LOCKED for discord outbox drain + DB-backed ops recent errors",
    "KPI drop alerts: scheduler checks funnels/5xx/backlog and enqueues Discord outbox alerts with cooldown + /ops recent alerts card"
  ],
  "commands": {
    "dev": "make dev",
    "test": "make test",
    "e2e": "make e2e",
    "seed": "make seed-data",
    "seed_reset": "make seed-data-reset",
    "ui_sync": "./scripts/sync_ui.sh",
    "ops_clean": "make ops-clean",
    "ops_metrics_rollup": "make ops-metrics-rollup",
    "ops_preflight": "make ops-preflight",
    "generate_pack": "make generate-pack",
    "balance_report": "make balance-report",
    "handoff": "make handoff",
    "prod_up": "make prod-up",
    "prod_down": "make prod-down",
    "prod_logs": "make prod-logs",
    "deploy_up": "make deploy-up",
    "deploy_down": "make deploy-down",
    "deploy_logs": "make deploy-logs"
  },
  "endpoints_added": [
    "/api/ready (DB/storage readiness check)",
    "/api/metrics (Prometheus text metrics)",
    "/api/matches/{match_id}/best_clip (best clip status + share URLs)",
    "/s/clip/{replay_id} (server-rendered OG landing + never-404 thumb placeholder)",
    "/s/clip/{replay_id}/kit.zip (creator kit zip: mp4/thumb/caption/qr, deterministic + ETag)",
    "/api/gallery/blueprints (browse submitted builds)",
    "/api/blueprints/import, /api/blueprints/{id}/fork, /api/blueprints/{id}/lineage",
    "/api/meta/weekly (weekly theme + featured portal/augment pools)",
    "/api/tournament/* (queue + me + leaderboard)",
    "/api/ops/balance/latest (ops balance snapshot API)",
    "/api/assets/{key:path} (public assets allowlist: clips/sharecards/ops)",
    "/api/clips/feed?algo=v2 (conversion-weighted trending)",
    "/api/clips/{replay_id}/event (adds completion event)",
    "/api/clips/{replay_id}/hide (user-level hide toggle)",
    "/api/reports (report clip/profile/build)",
    "/api/ops/reports (admin-gated reports listing)",
    "/api/events/track (canonical growth event tracking)",
    "/api/experiments/assign (deterministic A/B assignments)",
    "/api/ops/metrics/* (admin-gated funnel/KPI/experiments)",
    "/api/ops/metrics/errors_recent (admin-gated recent errors, last 60m)",
    "/api/ops/metrics/funnel_daily (admin-gated daily funnel series)",
    "/api/ops/metrics/rollup (admin-gated metrics rollup trigger)",
    "/api/ops/status (admin-gated deploy sanity summary)",
    "/api/ops/featured/preview?offset_days=1 (admin featured tomorrow preview)",
    "/api/ops/weekly + /api/ops/weekly/override (admin weekly theme override)",
    "/api/ops/packs* (admin pack candidate/promote workflow)",
    "/api/auth/discord/start + /api/auth/discord/callback (optional OAuth login / guest upgrade)",
    "/api/users/{id}/follow + /api/feed/activity (follow + following feed)",
    "/api/challenges/* (Beat This challenges + deterministic match ids)",
    "/s/challenge/{id} (server-rendered OG landing for challenges)",
    "/api/ops/preflight/latest (admin-gated latest patch preflight report)",
    "/s/qr.png (deterministic QR PNG for /start deep links)",
    "/s/track (public share landing tracking endpoint)",
    "/s/clip/{replay_id}/video.mp4 (public cached MP4 for share kit download)",
    "/api/meta/flags (frontend feature flags: demo_mode/log_json/alerts_enabled)",
    "/api/demo/presets (Steam Demo presets)",
    "/api/demo/run (deterministic demo match/replay/challenge generator)",
    "/api/ops/metrics/alerts_recent (admin-gated alerts audit + last_run)"
  ],
  "key_files": [
    "services/api/neuroleague_api/core/config.py",
    "services/api/neuroleague_api/main.py",
    "services/api/neuroleague_api/storage_backend.py",
    "services/api/neuroleague_api/storage.py",
    "services/api/neuroleague_api/balance_report.py",
    "services/api/neuroleague_api/ops_cleanup.py",
    "services/api/neuroleague_api/routers/assets.py",
    "services/api/neuroleague_api/routers/ops.py",
    "services/api/neuroleague_api/routers/reports.py",
    "services/api/neuroleague_api/routers/clips.py",
    "services/api/neuroleague_api/routers/share.py",
    "services/api/neuroleague_api/routers/replays.py",
    "services/api/neuroleague_api/routers/matches.py",
    "services/api/neuroleague_api/eventlog.py",
    "services/api/neuroleague_api/growth_metrics.py",
    "services/api/neuroleague_api/routers/events.py",
    "services/api/neuroleague_api/routers/experiments.py",
    "services/api/neuroleague_api/routers/challenges.py",
    "packages/sim/neuroleague_sim/pack_loader.py",
    "scripts/metrics_rollup.py",
    "scripts/patch_preflight.py",
    "apps/web/src/pages/OpsPage.tsx",
    "apps/web/src/pages/ChallengePage.tsx",
    "services/api/neuroleague_api/ray_tasks.py",
    "scripts/cleanup_jobs.py",
    "scripts/balance_report.py",
    "scripts/seed_data.py",
    "apps/web/src/pages/MetaPage.tsx",
    "docker-compose.deploy.yml",
    "deploy/Caddyfile",
    ".env.deploy.example",
    "services/api/neuroleague_api/scheduler_main.py",
    "services/api/neuroleague_api/featured_rotation.py",
    "services/api/neuroleague_api/routers/ops.py",
    "apps/web/src/pages/OpsWeeklyPage.tsx",
    "apps/web/src/pages/OpsPacksPage.tsx",
    "apps/web/src/pages/SocialPage.tsx"
  ],
  "known_issues": [
    "Balance Watch requires enough ranked samples to show meaningful over/underperforming lists (defaults to >=50).",
    "S3 backend is optional and not exercised by CI; local filesystem remains the default backend.",
    "Sharecard v2 depends on Playwright/Chromium; first render may be slower until cached.",
    "Local WSL environments may not have Docker; deploy reproducibility is validated in GitHub Actions deploy-smoke-compose.",
    "Alerts require a scheduler/outbox drain loop running at least hourly (recommended: 15–60m) to be timely in production.",
    "Postgres advisory locks are Postgres-only; local sqlite dev treats advisory locks as no-op.",
    "Creator kit zip is built server-side from cached assets; for S3/CDN backends this can require downloading the MP4/thumb to the API instance (optimize in v2).",
    "ops-clean only purges cache files for the local backend (S3 deletion is out of scope for this sprint).",
    "Pack promotion is an ops workflow record (candidate/promote); applying a new pack requires redeploy/restart with NEUROLEAGUE_ACTIVE_RULESET_VERSION set.",
    "Discord OAuth is optional; if client id/secret are not configured the app will use mock mode (intended for local dev/E2E)."
  ],
  "screenshots": [
    "docs/screenshots/01_home.png",
    "docs/screenshots/18_best_clip_vertical.png",
    "docs/screenshots/19_share_landing_bestclip.png",
    "docs/screenshots/25_clips.png",
    "docs/screenshots/27_s_build.png",
    "docs/screenshots/33_ops.png",
    "docs/screenshots/40_ops_deploy_sanity.png",
    "docs/screenshots/41_ops_featured.png",
    "docs/screenshots/46_forge_build_code_import_modal.png",
    "docs/screenshots/49_build_code_import_ranked_done.png",
    "docs/screenshots/50_demo_home_cta.png",
    "docs/screenshots/51_demo_page.png",
    "docs/screenshots/52_demo_done.png",
    "docs/screenshots/53_demo_replay.png"
  ],
  "last_handoff_tag": "handoff/20260121_045048",
  "base": "handoff/20260121_045048",
  "recent_commits": [
    "7474b4d feat(analytics): shorts variant breakdown + propagation",
    "04b99f6 feat(android): TWA wrapper + assetlinks + deeplink events",
    "518238b feat(onboarding): first win in 45s share→ranked flow",
    "29ebb17 feat(captions): captions_v2 templates + CAPTIONS_VERSION bump",
    "149bb08 feat(clips): mint share URLs with clip_len_v1"
  ],
  "changed_files_since_base": [
    ".env.deploy.example",
    "apps/android-twa/.gitignore",
    "apps/android-twa/app/build.gradle",
    "apps/android-twa/app/proguard-rules.pro",
    "apps/android-twa/app/src/main/AndroidManifest.xml",
    "apps/android-twa/app/src/main/java/com/neuroleague/twa/DeeplinkAnalytics.kt",
    "apps/android-twa/app/src/main/java/com/neuroleague/twa/MainActivity.kt",
    "apps/android-twa/app/src/main/res/values/strings.xml",
    "apps/android-twa/app/src/main/res/values/styles.xml",
    "apps/android-twa/build.gradle",
    "apps/android-twa/gradle.properties",
    "apps/android-twa/gradle/wrapper/gradle-wrapper.jar",
    "apps/android-twa/gradle/wrapper/gradle-wrapper.properties",
    "apps/android-twa/gradlew",
    "apps/android-twa/gradlew.bat",
    "apps/android-twa/settings.gradle",
    "apps/web/e2e/first5min.spec.ts",
    "apps/web/src/lib/experiments.ts",
    "apps/web/src/lib/shareVariants.ts",
    "apps/web/src/pages/ClipsPage.tsx",
    "apps/web/src/pages/HomePage.tsx",
    "apps/web/src/pages/OpsPage.tsx",
    "apps/web/src/pages/QuickPage.tsx",
    "apps/web/src/pages/RankedPage.tsx",
    "apps/web/src/pages/ReplayPage.tsx",
    "apps/web/src/pages/StartPage.tsx",
    "apps/web/vite.config.ts",
    "docs/RUNBOOK_ANDROID_DEEPLINKS.md",
    "scripts/seed_data.py",
    "services/api/neuroleague_api/clip_render.py",
    "services/api/neuroleague_api/core/config.py",
    "services/api/neuroleague_api/experiments.py",
    "services/api/neuroleague_api/growth_metrics.py",
    "services/api/neuroleague_api/main.py",
    "services/api/neuroleague_api/routers/auth.py",
    "services/api/neuroleague_api/routers/clips.py",
    "services/api/neuroleague_api/routers/events.py",
    "services/api/neuroleague_api/routers/matches.py",
    "services/api/neuroleague_api/routers/ops.py",
    "services/api/neuroleague_api/routers/share.py",
    "services/api/neuroleague_api/routers/well_known.py",
    "tests/test_api_schema.py",
    "tests/test_best_clip.py",
    "tests/test_clip_share_url.py",
    "tests/test_ops_metrics_api.py"
  ],
  "diff_stat_since_base": " .env.deploy.example                                |   7 +\n apps/android-twa/.gitignore                        |  14 +\n apps/android-twa/app/build.gradle                  |  40 +\n apps/android-twa/app/proguard-rules.pro            |   2 +\n apps/android-twa/app/src/main/AndroidManifest.xml  |  40 +\n .../java/com/neuroleague/twa/DeeplinkAnalytics.kt  |  86 ++\n .../main/java/com/neuroleague/twa/MainActivity.kt  |  24 +\n .../app/src/main/res/values/strings.xml            |   7 +\n .../android-twa/app/src/main/res/values/styles.xml |   4 +\n apps/android-twa/build.gradle                      |  22 +\n apps/android-twa/gradle.properties                 |   4 +\n apps/android-twa/gradle/wrapper/gradle-wrapper.jar | Bin 0 -> 43453 bytes\n .../gradle/wrapper/gradle-wrapper.properties       |   6 +\n apps/android-twa/gradlew                           | 249 ++++++\n apps/android-twa/gradlew.bat                       |  92 ++\n apps/android-twa/settings.gradle                   |   3 +\n apps/web/e2e/first5min.spec.ts                     | 927 +--------------------\n apps/web/src/lib/experiments.ts                    |   3 +-\n apps/web/src/lib/shareVariants.ts                  |  55 ++\n apps/web/src/pages/ClipsPage.tsx                   |  35 +-\n apps/web/src/pages/HomePage.tsx                    |   3 +-\n apps/web/src/pages/OpsPage.tsx                     |  78 ++\n apps/web/src/pages/QuickPage.tsx                   |   4 +-\n apps/web/src/pages/RankedPage.tsx                  |   3 +-\n apps/web/src/pages/ReplayPage.tsx                  | 116 ++-\n apps/web/src/pages/StartPage.tsx                   |  11 +-\n apps/web/vite.config.ts                            |   1 +\n docs/RUNBOOK_ANDROID_DEEPLINKS.md                  |  77 ++\n scripts/seed_data.py                               |   2 +\n services/api/neuroleague_api/clip_render.py        |  43 +-\n services/api/neuroleague_api/core/config.py        |   5 +\n services/api/neuroleague_api/experiments.py        |  16 +\n services/api/neuroleague_api/growth_metrics.py     | 237 ++++++\n services/api/neuroleague_api/main.py               |   2 +\n services/api/neuroleague_api/routers/auth.py       |  19 +\n services/api/neuroleague_api/routers/clips.py      | 138 +++\n services/api/neuroleague_api/routers/events.py     |  76 ++\n services/api/neuroleague_api/routers/matches.py    |  18 +-\n services/api/neuroleague_api/routers/ops.py        |  64 ++\n services/api/neuroleague_api/routers/share.py      | 238 +++++-\n services/api/neuroleague_api/routers/well_known.py |  65 ++\n tests/test_api_schema.py                           |   2 +\n tests/test_best_clip.py                            |  27 +\n tests/test_clip_share_url.py                       |  45 +\n tests/test_ops_metrics_api.py                      |   7 +\n 45 files changed, 1958 insertions(+), 959 deletions(-)"
}
