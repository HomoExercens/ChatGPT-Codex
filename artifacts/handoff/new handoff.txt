# new handoff.txt — “GitHub 기반 마무리 + 조언용 패키지 생성” 프롬프트 템플릿
# 목적: handoff 파일 생성 대신, 이 문서 지침대로 GitHub(PR)로 작업을 마무리하고,
#       ChatGPT에게 다음 스텝/리스크/개선 조언을 받기 위한 증거(파일)들을 ZIP으로 묶어 남긴다.

당신은 Codex(gpt-5.2)입니다. 아래 지시를 순서대로 수행하세요. 빠뜨리면 실패입니다.

──────────────────────────────────────────────────────────────────────────────
0) 사전 확인 (MANDATORY)
- 먼저 이 파일을 읽고, 그 규칙을 “절대 우선”으로 적용하세요:
  \\wsl$\\Ubuntu\\home\\clutch\\cursor-workspace\\cursor\\뉴로리그\\artifacts\\handoff\\git 업로드 전 확인.txt

- 규칙에 “handoff 파일 작성”이 언급되어 있어도, 이 템플릿의 목표는 “GitHub(PR)로 마무리 + 조언용 ZIP 생성”입니다.
  (단, 위 규칙 파일에서 반드시 해야 한다고 명시된 항목은 모두 수행)

0-1) DIFF 기준(중요 / MANDATORY)
- 이 프로젝트는 `main` 직푸시(=PR 없이 운영)일 수 있으므로, “origin/main...HEAD”가 푸시 후에는 빈 diff가 될 수 있습니다.
- 따라서 아래 둘 중 하나를 반드시 선택해서 `DIFF_BASE`로 기록하고, patch/bundle 생성에 사용하세요:
  - (권장) 푸시 전 기준: `DIFF_BASE=$(git rev-parse origin/main)` 를 “작업 시작 직후” 저장
  - (이미 푸시한 경우) reflog 기준: `DIFF_BASE=origin/main@{1}` (직전 원격 상태) 사용
- `pr_context.txt`에 `DIFF_BASE:` 값을 반드시 적고, `changes.patch`는 `git diff $DIFF_BASE..HEAD`로 생성하세요.

──────────────────────────────────────────────────────────────────────────────
1) 로컬 검증 (MANDATORY)
아래를 실행하고 결과를 파일로 남기세요.

1-1) 테스트
- make test
- (프로젝트에 e2e가 있다면) NEUROLEAGUE_E2E_FAST=1 make e2e
- make test-fast
- 규칙 파일에 다른 커맨드가 있으면 추가로 실행

1-2) 상태/변경 요약
- git status --porcelain
- git log -10 --oneline
- git diff --stat $DIFF_BASE..HEAD
- git diff $DIFF_BASE..HEAD (반드시 patch도 만들 것)
- (선택) git show --name-only HEAD

──────────────────────────────────────────────────────────────────────────────
2) GitHub 활용 마무리 (MANDATORY)
규칙 파일(git 업로드 전 확인.txt)을 따라 GitHub로 마무리하세요.

- 이 프로젝트는 “PR 없이 main 직푸시” 운영일 수 있습니다(규칙 파일이 소스 오브 트루스).
- 따라서 본 단계의 목적은 “웹 UI PR 생성”이 아니라, 다음을 안전하게 완료하는 것입니다:
  - (필수) 규칙 파일 체크리스트 준수 후 `main` 푸시 (force 금지)
  - (필수) 붙여넣기 가능한 PR 텍스트(PR_READY)를 생성해 ZIP에 포함 (운영자/다음 담당자용)

2-1) 브랜치/커밋
- 규칙 파일이 `main` 직푸시를 요구하면: `main`에서 작업/커밋/푸시
- 규칙 파일이 PR 워크플로우를 요구하면: feature 브랜치에서 작업 (예: feat/shorts-engine-<date>)
- 커밋 메시지는 명확하게(변경 범위/의도/영향)

2-2) PR 준비
- PR 템플릿이 있으면 반드시 따르기
- PR 본문에 최소 포함:
  - What changed / Why
  - How to verify (명령 + 기대 결과)
  - 리스크/롤백
  - 실험 키/변형(clip_len_v1, captions_v2 등) + 분석 포인트
  - 결정론/캐시 키/버전 전파 관련 메모
  - Android(App Links/TWA)라면 검증 커맨드/체크리스트
- (운영 필수) “Operational Notes” 섹션을 추가하고, 아래 7개를 반드시 명시:
  1) 설정 추가/변경(이름 + 기대 포맷): Android AssetLinks fingerprints, bandit enable/override, HQ render 플래그
  2) bandit 가드레일 “숫자”: `min_share`, `max_share`, `threshold_n`, `margin`, `window(days)` (코드 기준값)
  3) bandit 킬스위치: 즉시 baseline 100%로 고정하는 정확한 절차(재현 가능한 명령/SQL 포함)
  4) 오프라인 큐 중복(dedupe) 전략: event idempotency 키 여부 + 서버 중복 방지 여부
  5) HQ 렌더 악용(비용 폭증) 방지: rate-limit/auth/권한 요구사항이 있는지(없으면 “없음”이라고 명시)
  6) CAPTIONS_VERSION 영향: 기존 캐시 보존 + 신규 출력은 버전드(키 분리)임을 명시
  7) 모니터링 체크리스트: render_jobs backlog/지연, app_open_deeplink 유입, primary KPI 변화
- CI(필수 체크)가 모두 green인지 확인 (규칙 파일 기준)

※ 주의: 이 자동화는 GitHub 웹 UI 조작이 아니라,
로컬에서 “푸시 + PR 생성에 필요한 정보(제목/본문)”를 완성하는 데 초점을 둡니다.
PR 생성이 CLI(gh)로 가능하면 gh를 사용해도 좋고, 불가능하면 “붙여넣기 가능한 PR 본문”을 출력하세요.

──────────────────────────────────────────────────────────────────────────────
3) ChatGPT 조언용 패키지 만들기 (MANDATORY)
아래 파일들을 생성/수집해서 ZIP으로 묶어 다음 경로에 저장하세요:

저장 경로:
\\wsl$\\Ubuntu\\home\\clutch\\cursor-workspace\\cursor\\뉴로리그\\artifacts\\handoff\\

ZIP 파일명 규칙(권장):
neuroleague_github_handoff_<YYYYMMDD_HHMMSS>.zip

ZIP에 포함할 파일들(상세, 누락 금지):

[A] 규칙/지침
1) artifacts/handoff/git 업로드 전 확인.txt
2) artifacts/handoff/new handoff.txt  (이 파일 자체도 포함: “어떤 규칙으로 만들었는지” 증거)

[B] PR 컨텍스트(필수)
3) artifacts/handoff/pr_context.txt  (새로 생성)
   아래 내용을 “그대로” 포함:
   - PR_TITLE: <제목>
   - PR_BRANCH: <브랜치명>
   - PR_BASE: main
   - PR_BODY: <PR 본문 전체(붙여넣기용)>
   - DIFF_BASE: <git rev-parse origin/main (푸시 전) 또는 origin/main@{1}>
   - TEST_COMMANDS_RUN: (실행한 커맨드 나열)
   - TEST_RESULTS_SUMMARY: (통과/실패 + 핵심 로그 요약)
   - GIT_STATUS: (git status --porcelain 출력)
   - GIT_LOG: (git log -10 --oneline 출력)
   - DIFF_STAT: (git diff --stat $DIFF_BASE..HEAD 출력)
   - RISK_ROLLBACK: (리스크/롤백 한 줄 요약)

[C] 변경 사항 증거(둘 중 하나는 반드시)
4) artifacts/handoff/changes.patch
   - 생성: git diff $DIFF_BASE..HEAD > artifacts/handoff/changes.patch
또는
5) artifacts/handoff/changes.bundle
   - 생성: git bundle create artifacts/handoff/changes.bundle $DIFF_BASE..HEAD

[D] 테스트 원본 로그(필수)
6) artifacts/handoff/make_test.log
7) artifacts/handoff/e2e_fast.log
8) artifacts/handoff/test_fast.log

[E] 핵심 문서/런북 변경이 있는 경우(있으면 반드시 포함)
9) 변경된 docs/ 파일 중 “핵심” 3~10개를 그대로 포함(복사본으로 ZIP에 넣기)
   - 예: docs/RUNBOOK_ANDROID_DEEPLINKS.md
   - 예: docs/HANDOFF_REPORT.md (있다면)

[F] (선택) 릴리즈 체크에 도움 되는 추가 정보
10) artifacts/handoff/env_notes.txt
   - 이번 작업에 필요한 환경 변수/시크릿/도메인/keystore 관련 “비밀 제외” 메모

──────────────────────────────────────────────────────────────────────────────
4) ZIP 생성 커맨드 예시 (반드시 실제로 실행)
- 폴더: \\wsl$\\Ubuntu\\home\\clutch\\cursor-workspace\\cursor\\뉴로리그\\artifacts\\handoff\\
- 예시(리눅스 경로 기준):
  cd /home/clutch/cursor-workspace/cursor/뉴로리그
  mkdir -p artifacts/handoff

  # pr_context.txt 작성 후
  # DIFF_BASE는 0-1) 규칙에 따라 반드시 설정
  git diff $DIFF_BASE..HEAD > artifacts/handoff/changes.patch
  make test 2>&1 | tee artifacts/handoff/make_test.log
  NEUROLEAGUE_E2E_FAST=1 make e2e 2>&1 | tee artifacts/handoff/e2e_fast.log
  make test-fast 2>&1 | tee artifacts/handoff/test_fast.log

  # zip 커맨드가 없을 수 있으므로 2가지 중 하나를 사용
  # (A) zip 설치되어 있으면
  # zip -r artifacts/handoff/neuroleague_github_handoff_$(date +%Y%m%d_%H%M%S).zip \
  #   artifacts/handoff/git\\ 업로드\\ 전\\ 확인.txt \
  #   artifacts/handoff/new\\ handoff.txt \
  #   artifacts/handoff/pr_context.txt \
  #   artifacts/handoff/changes.patch \
  #   artifacts/handoff/make_test.log \
  #   artifacts/handoff/e2e_fast.log \
  #   artifacts/handoff/test_fast.log \
  #   docs/RUNBOOK_ANDROID_DEEPLINKS.md
  # (B) zip 명령이 없으면 (python3)
  python3 - <<'PY'
from __future__ import annotations
from datetime import datetime
from pathlib import Path
import zipfile
root = Path('.').resolve()
ts = datetime.now().strftime('%Y%m%d_%H%M%S')
zip_path = root / 'artifacts' / 'handoff' / f'neuroleague_github_handoff_{ts}.zip'
files = [
  Path('artifacts/handoff/git 업로드 전 확인.txt'),
  Path('artifacts/handoff/new handoff.txt'),
  Path('artifacts/handoff/pr_context.txt'),
  Path('artifacts/handoff/changes.patch'),
  Path('artifacts/handoff/make_test.log'),
  Path('artifacts/handoff/e2e_fast.log'),
  Path('artifacts/handoff/test_fast.log'),
  Path('docs/RUNBOOK_ANDROID_DEEPLINKS.md'),
]
missing = [p.as_posix() for p in files if not p.exists()]
if missing:
  raise SystemExit(f'missing files: {missing}')
zip_path.parent.mkdir(parents=True, exist_ok=True)
with zipfile.ZipFile(zip_path, 'w', compression=zipfile.ZIP_DEFLATED) as z:
  for p in files:
    z.write(p, p.as_posix())
print(zip_path)
PY

※ docs 전체를 넣기 부담이면, 변경된 docs만 골라 포함하세요(단, 핵심 런북/규칙 문서는 반드시).

──────────────────────────────────────────────────────────────────────────────
5) 최종 출력 (MANDATORY)
작업을 끝내면 아래를 “텍스트로” 출력하세요:
- ZIP_READY: <생성된 zip의 리눅스 절대경로> | <동일 zip의 WSL UNC 절대경로(\\\\wsl$\\\\Ubuntu\\\\...)>
- PR_READY:
  - TITLE: ...
  - BRANCH: ...
  - BODY: (붙여넣기용 전체 본문)
- VERIFY_DONE:
  - 실행한 테스트 커맨드 목록 + PASS/FAIL
  - 규칙 파일 준수 체크리스트(가능하면 체크 표시)

끝.

──────────────────────────────────────────────────────────────────────────────
변경 이력
- 2026-01-23: 운영자 관점으로 규칙 강화(Operational Notes 강제, ZIP_READY 절대경로 강제, zip 구성에 규칙 파일/`test_fast.log` 추가, `DIFF_BASE` 도입으로 직푸시 후 빈 diff 문제 방지, zip 미설치 환경을 위한 python3 zip 예시 추가). 
